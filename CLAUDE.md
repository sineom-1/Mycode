# Claude 编程协作规范

> 核心理念：如无必要，勿增实体。简单优于复杂，清晰优于晦涩。

## 1) 语言与沟通

- 与用户沟通：一律简体中文。
- 与外部模型/工具交互：`PROMPT` 以英文为主；但涉及前端/移动端/小程序等需求时，必须在 `PROMPT` 中包含用户原始需求（尽量原文粘贴，不要转述/改写）。

## 2) 核心原则（KISS 优先）

- 奥卡姆 / KISS / YAGNI：最简单可行方案；标准库优先；不做未提需求的扩展。
- SRP / OCP / DRY：职责单一；消除重复；扩展不破坏既有行为。
- 最小改动：只改与需求相关的范围；不顺手“顺便优化”。
- 多模型协作：按需使用 Codex/Gemini 做原型、Debug 与 Review；任何外部产出仅作参考，需质疑其结论并独立判断。
- 原型前置：需要原型时必须索要统一 diff（read-only）；原型不可直接套用，必须按项目规范重写为生产级代码。
- 立即审查：完成编码后进行质量审查，覆盖需求完成度、逻辑/性能/安全风险。
- 检索-提问-定位循环：先尽量检索相关文件，再多角度提问澄清需求，精准定位改动点，信息不足则继续迭代。
- 代码最小化：只做需求内改动，风格精简高效，必要时用简短伪代码说明计划。
- 语言分工：与用户中文；与外部模型/工具英文（命令、标识符、日志保持原文）。
- 前端铁律：前端/移动端需求优先用 Gemini；不得让 Gemini 编写复杂后端逻辑；以 Gemini 原型为基点重写。

## 3) 默认工作流（可按需降级）

1. **理解**：最小范围检索现有实现与项目约定（以代码与文档证据为准，不猜）。
2. **澄清**：列出关键问题与验收标准；信息不足时优先向用户提问并等待确认。
3. **规划**：形成 ≤6 条可执行步骤；需要多模型协作时按“前端/需求澄清 → Gemini，后端/逻辑 → Codex”分工讨论；中等以上改动建议使用 `/dev` 全流程。
4. **原型（如需）**：按需向 Codex/Gemini 索要原型（必须 read-only，且只输出 unified diff patch），仅作参考；再按项目规范重写为生产级实现。
5. **实现**：聚焦范围，保证可验证（测试/命令/回归路径）；未得到用户明确同意不修改文件。
6. **审查**：完成后必须进行质量审查（需求匹配、逻辑/性能/安全风险）；默认使用 `collaborating-with-codex` 做 review；工具不可用则自查并标注缺口，必要时迭代修复。
7. **汇报**：变更摘要、修改文件、验证方式、风险与下一步建议。

## 4) Commands / Agents（推荐入口）

- `/explore`：入口定位与调用链（agent: `explorer`）
- `/plan`：方案设计与任务拆解（agent: `architect`）
- `/code`：实现与必要质量补齐（agent: `coder`）
- `/check`：审查/测试/诊断（agent: `guardian`）
- `/doc`：文档与变更说明（agent: `doc-writer`）
- `/dev`：完整 feature-dev 流程（强约束，适合中大型需求）

## 5) Codex / Gemini（CLI Bridge skills）

- `collaborating-with-codex`：后端原型、Debug、Review；必须保存/复用 `SESSION_ID`；原型阶段必须 read-only 且只输出 unified diff。
- `collaborating-with-gemini`：需求澄清、任务规划、前端/移动端原型；前端需求尽量原文粘贴；严禁让 Gemini 编写复杂后端逻辑。
- 细则与参数：见 `skills/collaborating-with-codex/SKILL.md`、`skills/collaborating-with-gemini/SKILL.md`；通用调用模板见 `skills/templates/SKILL.md`。
- 共同要求：Codex/Gemini 仅为参考，必须批判性审视并独立判断；原型不可直接套用；外部模型不得直接写文件（以 unified diff 作为只读输入）。

## 6) 工具调用与降级

- 调用优先级：代码检索（Relace）→ 官方文档（Context7）→ 复杂规划（Sequential Thinking）→ 外部搜索（DuckDuckGo 官方域）→ Playwright/DeepWiki（确需时）。
- 外部调用：每轮最多 1 个 MCP 服务；限定 `relative_path/topic`；失败重试一次后降级本地处理并标注缺口。
- 会话管理：Codex/Gemini 必须记录并复用 `SESSION_ID`，避免上下文丢失。

## 7) Git 提交信息（如需）

- 历史风格：先执行 `git log -n 5` 观察仓库既有风格。
- 版本检测：优先从 `package.json` / `pom.xml` / 最新 git tag 等确定当前版本；无法检测则**省略版本前缀**（禁止猜测）。
- 提交信息格式：`[版本号]：[摘要]。[详情，以分号分隔];`
  - 语言：中文（简体）；正文**单段落**（不换行）
  - 禁止：`Co-Authored-By`、`Generated by`、AI 免责声明

## 8) 禁止事项

- 跳过关键澄清、直接拍脑袋实现。
- 跳过原型或审查；直接照搬原型不重写。
- 未经请求扩大改动范围或预留未来扩展。
- 不记录/不复用 `SESSION_ID`。
- 新增/修改文件使用非 UTF-8（无 BOM）或引入乱码。

## 9) 附录：工具调用规范

- 通用
  - 每轮最多 1 个 MCP 服务；限定 `relative_path/topic`，避免过度抓取。
  - 原型阶段必须 `sandbox="read-only"`，并要求**只输出 unified diff patch**（不得直接写文件）。
  - Codex/Gemini 必须保存并复用 `SESSION_ID`，避免上下文丢失。
- Codex / Gemini
  - 细则与参数：见 `skills/collaborating-with-codex/SKILL.md`、`skills/collaborating-with-gemini/SKILL.md`。
- Relace（代码检索与编辑）
  - `relace_search`：语义化代码搜索，查询使用自然语言（如 "How is authentication implemented?"）；必须指定 `workdir` 为项目绝对路径。
  - `fast_apply`：高速代码编辑（10,000+ tokens/sec）；使用截断占位符（`// ... existing code ...`）标记保留区域；返回 UDiff。
  - `cloud_sync` / `cloud_search`：同步代码库到 Relace Cloud 并进行云端语义搜索；大型项目或需要跨分支搜索时使用。
  - `cloud_list` / `cloud_info` / `cloud_clear`：云端仓库管理。
  - 适用场景：定位文件、理解代码流程、批量编辑、深度语义搜索。
- Context7（官方文档）
  - 流程：`resolve-library-id` → `get-library-docs`；tokens≤5000，指定 topic，必要时翻页；mode=code/info 视需求而定。
  - 单轮仅调用一个外部文档服务；无法获取时降级 DuckDuckGo（同一轮不要并行外部搜索）。
- Sequential Thinking（复杂规划）
  - 适用：非简单任务的多步骤规划/诊断；输出 6–10 步可执行计划，不暴露推理过程。
  - 参数：`total_thoughts≤10`；完成后更新 plan 或直接执行。
- Shrimp Task Manager（任务拆分/跟踪）
  - 用途：`split_tasks` / `plan_task` / `execute_task` / `update_task` / `verify_task`。
  - `updateMode` 默认 `clearAllTasks`（除非明确需要保留旧任务）；JSON 禁止注释；任务保持原子性并写清 `dependencies`。
  - 仅需清空旧任务集时用 `clearAllTasks`；需要保留任务时优先 `append` / `selective`。
- 降级
  - 工具失败：重试一次 → 本地处理并在汇报中标注缺口/风险。

```markdown
# Global Protocols

- 语言：与用户简体中文；与工具/外部模型英文（命令、标识符、日志保持原文）。
- Workflow：严格按“检索 → 澄清 → 计划 →（可选原型）→ 实现 → 审查 → 汇报”推进；进入“实现”（修改文件）前必须获得用户明确批准。
- 多模型协作（可选，但推荐用于中大型需求）：
  - 后端/逻辑/Review：优先 Codex；前端/UI/样式：优先 Gemini
  - 调用形态：`python /path/to/scripts/*_bridge.py --cd "/path/to/project" --PROMPT "..." [OPTIONS]`
  - 原型/补丁约束：必须要求 “OUTPUT: Unified Diff Patch ONLY. Do not modify files.”
  - 会话：捕获并复用 `SESSION_ID`（续对话追加 `--SESSION_ID <ID>`）
- 代码主权：外部模型产出视为“脏原型”，仅作参考；必须审视后按项目规范重写。
```
